<!DOCTYPE html><html><head>
      <title>1_connections</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/samuel/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.3.13/node_modules/@shd101wyy/mume/dependencies/katex/katex.min.css">
      
      
      
      
      
      
      
      
      

      <style> 
      pre{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;padding:1em;margin:.5em 0;overflow:auto;line-height:1.5;tab-size:4;hyphens:none;color:#c5c8c6;background-color:#27292c !important;border:#43484c;border-radius:3px}pre[class*="language-"]{padding:1em}code[class*="language-"] .token.comment,pre[class*="language-"] .token.comment,code[class*="language-"] .token.prolog,pre[class*="language-"] .token.prolog,code[class*="language-"] .token.doctype,pre[class*="language-"] .token.doctype,code[class*="language-"] .token.cdata,pre[class*="language-"] .token.cdata{color:#7C7C7C}code[class*="language-"] .token.punctuation,pre[class*="language-"] .token.punctuation{color:#96CBFE}code[class*="language-"] .namespace,pre[class*="language-"] .namespace{opacity:.7}code[class*="language-"] .token.constant,pre[class*="language-"] .token.constant{color:#99CC99}code[class*="language-"] .token.boolean,pre[class*="language-"] .token.boolean,code[class*="language-"] .token.number,pre[class*="language-"] .token.number,code[class*="language-"] .token.function-name,pre[class*="language-"] .token.function-name{color:#FF73FD}code[class*="language-"] .token.tag,pre[class*="language-"] .token.tag{color:#96CBFE}code[class*="language-"] .token.selector,pre[class*="language-"] .token.selector{color:#96CBFE}code[class*="language-"] .token.attr-name,pre[class*="language-"] .token.attr-name{color:#C6C5FE}code[class*="language-"] .token.string,pre[class*="language-"] .token.string{color:#A8FF60}code[class*="language-"] .token.char,pre[class*="language-"] .token.char{color:#FF8000}code[class*="language-"] .token.entity,pre[class*="language-"] .token.entity{color:#FFD2A7}code[class*="language-"] .token.url,pre[class*="language-"] .token.url{color:#7C7C7C}code[class*="language-"] .token.operator,pre[class*="language-"] .token.operator{color:#EDEDED}code[class*="language-"] .token.atrule,pre[class*="language-"] .token.atrule,code[class*="language-"] .token.attr-value,pre[class*="language-"] .token.attr-value,code[class*="language-"] .token.keyword,pre[class*="language-"] .token.keyword{color:#CFCB90}code[class*="language-"] .token.function,pre[class*="language-"] .token.function{color:#FFD2A7}code[class*="language-"] .token.class-name,pre[class*="language-"] .token.class-name{color:#FFD2A7}code[class*="language-"] .token.variable,pre[class*="language-"] .token.variable{color:#C6C5FE}code[class*="language-"] .token.regex,pre[class*="language-"] .token.regex,code[class*="language-"] .token.important,pre[class*="language-"] .token.important{color:#E9C062}code[class*="language-"] .token.important,pre[class*="language-"] .token.important,code[class*="language-"] .token.bold,pre[class*="language-"] .token.bold{font-weight:bold}code[class*="language-"] .token.italic,pre[class*="language-"] .token.italic{font-style:italic}code[class*="language-"] .token.entity,pre[class*="language-"] .token.entity{cursor:help}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:rgba(153,122,102,0.08);background:linear-gradient(to right, rgba(153,122,102,0.1) 70%, rgba(153,122,102,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:rgba(153,122,102,0.4);color:#f5f2f0;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px white}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}body{font-size:16px;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;background:#363B40;color:#b8bfc6;fill:currentColor;font-style:normal;line-height:1.625rem;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif}body hr{height:2px;border:0;margin:50px 0 !important}body h1,body h2,body h3,body h4,body h5,body h6{font-family:"Lucida Grande","Corbal",Georgia,serif;font-weight:normal;clear:both;-ms-word-wrap:break-word;word-wrap:break-word;margin:0;padding:0}body h1{font-size:2.25rem;line-height:2.5rem;margin-bottom:1.5rem;letter-spacing:-1.5px}body h2{font-size:1.5rem;line-height:1.875rem;margin-bottom:1.5rem;letter-spacing:-1px}body h3{font-size:1.125rem;line-height:1.5rem;margin-bottom:1.5rem;letter-spacing:-1px}body h4{font-size:1rem;line-height:1.375rem;margin-bottom:1.5rem}body h5{font-size:1rem;line-height:1.25rem;margin-bottom:1.5rem}body h6{font-size:1rem;line-height:1rem;margin-bottom:.75rem;font-weight:bold}body a{text-decoration:none;outline:0}body a:hover{outline:0}body a:focus{outline:thin dotted}body p{-ms-word-wrap:break-word;word-wrap:break-word}body p,body ul,body dd,body ol,body hr,body address,body pre,body table,body iframe,body .wp-caption,body .wp-audio-shortcode,body .wp-video-shortcode{margin-top:0;margin-bottom:1.5rem}body audio:not([controls]){display:none}body [hidden]{display:none}body ::-moz-selection{background:#4a89dc;color:#fff;text-shadow:none}body *.in-text-selection,body ::selection{background:#4a89dc;color:#fff;text-shadow:none}body ul,body ol{padding:0 0 0 1.875rem}body ul{list-style:square}body ol{list-style:decimal}body ul ul,body ol ol,body ul ol,body ol ul{margin:0}body b,body th,body dt,body strong{font-weight:bold}body i,body em,body dfn,body cite{font-style:italic}body blockquote{padding-left:1.875rem;margin:0 0 1.875rem 1.875rem;border-left:solid 2px #474d54;padding-left:30px;margin-top:35px}body pre,body code,body kbd,body tt,body var{background:rgba(0,0,0,0.05);font-size:.875rem;font-family:Monaco,Consolas,"Andale Mono","DejaVu Sans Mono",monospace}body pre.md-fences{padding:10px 30px;margin-bottom:20px;border:1px solid}body .md-fences .code-tooltip{bottom:-3.2em}body code,body kbd,body tt,body var{padding:2px 5px}body table{max-width:100%;width:100%;border-collapse:collapse;border-spacing:0}body th,body td{padding:5px 10px;vertical-align:top}body a{-webkit-transition:all .2s ease-in-out;transition:all .2s ease-in-out}body hr{background:#474d54}body #write>*:first-child{margin-top:40px}body h1{margin-top:2em}body h1,body h2,body h3,body h4,body h5,body h6,body p,body .mathjax-exps,body .math,body li,body table{color:#DEDEDE}body a{color:#e0e0e0;text-decoration:underline}body a:hover{color:#fff}body b,body th,body dt,body strong{color:#DEDEDE}body mark{background:#D3D40E}body blockquote{color:#9DA2A6}body table a{color:#DEDEDE}body th,body td{border:solid 1px #474d54;text-align:left}body li>p{margin-top:0;margin-bottom:0}body .task-list{padding-left:0}body .task-list-item{list-style:none;margin-left:-2em}body .task-list-item .task-list-item-checkbox{margin-right:.8em}body .task-list-item input{top:.1875rem}body .task-list-item input:before{content:"";display:inline-block;width:.875rem;height:.875rem;vertical-align:middle;text-align:center;border:1px solid #b8bfc6;background-color:#363B40;margin-top:-0.4375rem}body .task-list-item input:checked:before,body .task-list-item input[checked]:before{content:'\221A';font-size:.625rem;line-height:.625rem;color:#DEDEDE}body img{max-width:100%}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
.markdown-preview.markdown-preview h1,
.markdown-preview.markdown-preview h2,
.markdown-preview.markdown-preview h3,
.markdown-preview.markdown-preview h4,
.markdown-preview.markdown-preview h5,
.markdown-preview.markdown-preview h6 {
  font-weight: bolder;
  text-decoration-line: underline;
}
 
      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview   ">
      <h1 class="mume-header" id="ground-up-tutorial-to-sqlalchemy-course-1">Ground Up tutorial to SQLAlchemy: Course 1</h1>

<div class="code-chunk" data-id="code-chunk-id-0" data-cmd="toc"><div class="input-div"><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><ul>
<li><a href="#ground-up-tutorial-to-sqlalchemy-course-1">Ground Up tutorial to SQLAlchemy: Course 1</a>
<ul>
<li><a href="#understanding-engine-and-connection">Understanding <code>Engine</code> and <code>Connection</code></a></li>
<li><a href="#working-with-engines-directly">Working with Engines directly</a>
<ul>
<li><a href="#understanding-resultproxyclose">Understanding <code>ResultProxy.close()</code></a>
<ul>
<li><a href="#the-soft-close">The Soft Close</a></li>
</ul>
</li>
<li><a href="#rowproxy-like-tuples-but-not-really"><code>RowProxy</code>: Like Tuples, but not really</a></li>
<li><a href="#multiple-rowproxy-is-returned-as-a-list">Multiple <code>RowProxy</code> is returned as a <code>list</code></a></li>
<li><a href="#queue-pool">Queue Pool</a></li>
</ul>
</li>
<li><a href="#transactions">Transactions</a>
<ul>
<li><a href="#not-everything-can-be-rolled-back">Not everything can be &quot;rolled back&quot;</a></li>
<li><a href="#what-exactly-is-being-rolled-back">What exactly is being rolled back?</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
</ul>
</li>
</ul>
<p>To truly appreciate the inner workings of SQLAlchemy, we need to fully grasp <strong>five main objects</strong> that are foundational to the SQLAlchemy module:</p>
<ul>
<li><code>Connection</code></li>
<li><code>ResultProxy</code></li>
<li><code>RowProxy</code></li>
<li><code>Transaction</code></li>
<li><code>Session</code></li>
</ul>
<h2 class="mume-header" id="understanding-engine-and-connection">Understanding <code>Engine</code> and <code>Connection</code></h2>

<p>The <code>Engine</code> is the starting point for any SQLAlchemy application. The official documentation calls it the <strong>home base</strong> for the actual database and its DBAPI, and a <code>Dialect</code> which describes how to talk to a specific kind of database/DBAPI combination.<br>
<img src="assets/sqla_engine_arch.png" alt></p>
<p>The code below creates an <code>engine</code>, which rereferences a <strong>Dialect</strong> object tailored for SQLite and a <strong>Pool</strong> object which will establish a DBAPI connection when a connection request is first received.</p>
<div class="code-chunk" data-id="code-chunk-id-1" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=1, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot;}" class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">&apos;sqlite:///:memory:&apos;</span><span class="token punctuation">,</span> echo<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>engine<span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"><pre class="language-text">Engine(sqlite:///:memory:)
</pre></div></div><p>Notice that the <code>Engine</code> and its underlying <code>Pool</code> doesn&apos;t establish the first actual DBAPI until the <code>Engine.connect()</code> method is called, or until an operation dependent on this method (such as <code>Engine.execute()</code>) is invoked. In this way, <code>Engine</code> and <code>Pool</code>is said to have a <em>lazy initialization</em> behavior.</p>
<blockquote>
<p>The typical usage of <code>create_engine()</code> is once per particular database URL, held globally for the lifetime of a single application process... it is most efficient when created just once at the module level of an application, not per-object or per-function call.</p>
</blockquote>
<p>The Engine can be used in one of two ways:</p>
<ul>
<li>Interact with the db directly by through SQL commands</li>
<li>Passed to a <code>Session</code> object to work with the ORM</li>
</ul>
<h2 class="mume-header" id="working-with-engines-directly">Working with Engines directly</h2>

<p>A common use-case is to procure a connection resource via the <code>Engine.connect()</code> method:</p>
<div class="code-chunk" data-id="code-chunk-id-2" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=2, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot;}" class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
connection <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">&apos;sqlite:///rcsample.db&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
result <span class="token operator">=</span> connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM response ORDER BY workshop_id desc LIMIT 10&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>col <span class="token keyword">for</span> col <span class="token keyword">in</span> result<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"><pre class="language-text">[&apos;id&apos;, &apos;workshop_id&apos;, &apos;difficulty&apos;, &apos;assistants_score&apos;, &apos;knowledge&apos;, &apos;objectives&apos;, &apos;timeliness&apos;, &apos;venue_score&apos;, &apos;satisfaction_score&apos;, &apos;comments&apos;]
</pre></div></div><p>The <code>connection</code> we created above is an instance of <code>Connection</code>, which is a <strong>proxy</strong> object for an actual DBAPI connection.</p>
<h3 class="mume-header" id="understanding-resultproxyclose">Understanding <code>ResultProxy.close()</code></h3>

<p>What about <code>result</code>? Well, <code>result</code> is an instance of <code>ResultProxy</code>, a <strong>proxy</strong> object that references a DBAPI cursor and provides a largely compatible inferface with that of the DBAPI cursor. The DBAPI cursor will be closed by the <code>ResultProxy</code> when all of its result rows are exhausted. A <code>ResultProxy</code> that returns no rows, such as that of an <code>UPDATE</code> statement, releases cursor resources immediately upon construction. Let&apos;s see an example of that:</p>
<div class="code-chunk" data-id="code-chunk-id-3" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=3, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot;}" class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
connection <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">&apos;sqlite:///rcsample.db&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
result <span class="token operator">=</span> connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM response ORDER BY workshop_id LIMIT 5&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>row<span class="token punctuation">[</span><span class="token string">&apos;comments&apos;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> result<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>row<span class="token punctuation">[</span><span class="token string">&apos;comments&apos;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> result<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>row<span class="token punctuation">[</span><span class="token string">&apos;comments&apos;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> result<span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"><pre class="language-text">[&quot;time too short, there&apos;s no immediate benefit of bringing laptop, too much learning in short amount of time&quot;, &apos;thankyou, training is good, helpful and educational, hope you can create show case that really corellated in real business&apos;, None, &apos;deep explanation, more time&apos;, &apos;give more study cases, focus more on coding practice&apos;]
[]
[]
</pre></div></div><p>Notice that after the first time, the result rows are exhausted so subsequent call to <code>print()</code> return an empty list. Similarly, when we use one of <code>fetchall()</code>, <code>fetchmany()</code> and <code>fetchone()</code> to fetch result rows, once all rows have been exhausted any subsequent rows will return an empty list.</p>
<div class="code-chunk" data-id="code-chunk-id-4" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=4, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot;}" class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
connection <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">&apos;sqlite:///rcsample.db&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
result <span class="token operator">=</span> connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;SELECT satisfaction_score, comments FROM response ORDER BY workshop_id LIMIT 5&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"><pre class="language-text">[(4, &quot;time too short, there&apos;s no immediate benefit of bringing laptop, too much learning in short amount of time&quot;), (5, &apos;thankyou, training is good, helpful and educational, hope you can create show case that really corellated in real business&apos;), (5, None), (4, &apos;deep explanation, more time&apos;), (4, &apos;give more study cases, focus more on coding practice&apos;)]
[]
[]
</pre></div></div><p>Why is it important to learn about the <code>ResultProxy.close()</code> method so early on in the Ground Up tutorial? Because it is very fundamental to how <code>ResultProxy</code> and how return sets in general will behave. It&apos;s a concept that seasoned developers familiar to SQL or those working with ORM will often take for granted; Inexperienced developers new to SQLAlchemy however often find confusing.</p>
<p>To add to said beginner&apos;s confusion, some of the operations don&apos;t seem all that obvious that the <code>ResultProxy.close()</code> would have been called. One common example is the <code>.first()</code> method.</p>
<p>The <code>first()</code> method fetches the first row and then close the result set unconditionally:</p>
<div class="code-chunk" data-id="code-chunk-id-5" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=5, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot;}" class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>exc <span class="token keyword">import</span> ResourceClosedError
connection <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">&apos;sqlite:///rcsample.db&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
result <span class="token operator">=</span> connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;SELECT satisfaction_score, comments FROM response ORDER BY workshop_id LIMIT 5&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span> 
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> ResourceClosedError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Resource Closed:&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"><pre class="language-text">(4, &quot;time too short, there&apos;s no immediate benefit of bringing laptop, too much learning in short amount of time&quot;)
Resource Closed: This result object is closed.
</pre></div></div><p>A quick recap:</p>
<pre data-role="codeBlock" data-info="py" class="language-python">engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">&apos;sqlite:///rcsample.db&apos;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>engine<span class="token punctuation">)</span> 
<span class="token comment"># returns: Engine(sqlite:///rcsample.db)</span>

connection <span class="token operator">=</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span>
<span class="token comment"># returns: &lt;sqlalchemy.engine.base.Connection object at 0x1069b7b00&gt;</span>

result <span class="token operator">=</span> connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM response ORDER BY workshop_id LIMIT 5&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token comment"># returns: &lt;sqlalchemy.engine.result.ResultProxy object at 0x1069b7b00&gt;</span>
</pre><h4 class="mume-header" id="the-soft-close">The Soft Close</h4>

<p><em>New in version 1.0.0</em><br>
The method releases all DBAPI cursor resources but leaves the <code>ResultProxy</code> &quot;open&quot; from a semantic perspective, meaning the <code>fetchXXX()</code> methods will continue to return empty results instead of raising a <code>ResourceClosedError</code> exception :</p>
<div class="code-chunk" data-id="code-chunk-id-6" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=6, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot;}" class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>exc <span class="token keyword">import</span> ResourceClosedError
connection <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">&apos;sqlite:///rcsample.db&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
result <span class="token operator">=</span> connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;SELECT satisfaction_score, comments FROM response ORDER BY workshop_id LIMIT 5&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span> 
    result<span class="token punctuation">.</span>_soft_close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> ResourceClosedError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Resource Closed:&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"><pre class="language-text">[(4, &quot;time too short, there&apos;s no immediate benefit of bringing laptop, too much learning in short amount of time&quot;), (5, &apos;thankyou, training is good, helpful and educational, hope you can create show case that really corellated in real business&apos;), (5, None), (4, &apos;deep explanation, more time&apos;), (4, &apos;give more study cases, focus more on coding practice&apos;)]
None
</pre></div></div><p>Instead of the exception, the try/except block returns a <code>None</code>.</p>
<h3 class="mume-header" id="rowproxy-like-tuples-but-not-really"><code>RowProxy</code>: Like Tuples, but not really</h3>

<p>Most of what you do with SQLAlchemy involves fetching some rows from a database. At first sight, it seems like SQLAlchemy returns a tuple. Look at the following code block and pay attention to the returned value of:</p>
<ul>
<li><code>fetched</code></li>
<li><code>fetched[:2]</code></li>
<li><code>len(fetched)</code></li>
</ul>
<div class="code-chunk" data-id="row-proxy-1" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=7, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot; id=&quot;row-proxy-1&quot;}" class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">&apos;sqlite:///rcsample.db&apos;</span><span class="token punctuation">)</span>
conn <span class="token operator">=</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

executed <span class="token operator">=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;SELECT timeliness, satisfaction_score, comments FROM response ORDER BY workshop_id  LIMIT 1 OFFSET 8&apos;</span><span class="token punctuation">)</span>
fetched <span class="token operator">=</span> executed<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span>
d<span class="token punctuation">[</span><span class="token string">&apos;timeliness&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> d<span class="token punctuation">[</span><span class="token string">&apos;satisfaction&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> d<span class="token punctuation">[</span><span class="token string">&apos;comments&apos;</span><span class="token punctuation">]</span> <span class="token operator">=</span> fetched
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><p>The returned value from one of the <code>fetchXXX()</code> method looks and <em>behaves</em> almost like a tuple in the way we perform indexing and slicing. <code>len()</code> also correctly prints the number of elements in the &quot;tuple&quot;:</p>
<div class="code-chunk" data-id="code-chunk-id-8" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=8, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot; continue=&quot;row-proxy-1&quot;}" class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>fetched<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>fetched<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>fetched<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"><pre class="language-text">(4, 4, &apos;workshoop is so good, more complex and more aplikatif&apos;)
(4, 4)
3
</pre></div></div><p>However, it is not an instance of the <code>tuple</code> class. If it were a tuple, we wouldn&apos;t expect <code>fetched[&apos;comments&apos;]</code> to work:</p>
<div class="code-chunk" data-id="code-chunk-id-9" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=9, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot; continue=&quot;row-proxy-1&quot;}" class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>fetched<span class="token punctuation">[</span><span class="token string">&apos;comments&apos;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>fetched<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"><pre class="language-text">workshoop is so good, more complex and more aplikatif
{&apos;timeliness&apos;: 4, &apos;satisfaction&apos;: 4, &apos;comments&apos;: &apos;workshoop is so good, more complex and more aplikatif&apos;}
False
True
</pre></div></div><p>If it is not a <code>tuple</code>, what then could it be?</p>
<p>Well, turns out it is a proxy, namely a <code>RowProxy</code>. This <code>RowProxy</code> allows for the values of the individual columns to be accessed in addition to the tuple-like slicing behavior. The documentation on <code>ResultProxy</code> reads:</p>
<blockquote>
<p>Individual columns may be accessed by their integer position, case-insensitive column name, or by schema.Column object</p>
</blockquote>
<p>This allows us to build our dictionary <code>d</code> through accessing the value specified by column names.</p>
<p>Like <code>tuple</code>, <code>RowProxy</code> does not support item assignment. The following code raises an exception:</p>
<div class="code-chunk" data-id="code-chunk-id-10" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=10, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot; continue=&quot;row-proxy-1&quot;}" class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>fetched<span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    fetched<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> error<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>

tup <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    tup<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span>
<span class="token keyword">except</span> TypeError <span class="token keyword">as</span> error<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"><pre class="language-text">(4, 4, &apos;workshoop is so good, more complex and more aplikatif&apos;)
&apos;RowProxy&apos; object does not support item assignment
&apos;tuple&apos; object does not support item assignment
</pre></div></div><p>This may remind more experienced developers of the <strong>immutability</strong> trait in tuples. When we assign <code>5</code> to the first value of the tuple we get a <code>TypeError</code>: when we do it to <code>RowProxy</code> the exact same exception was raised (both are <code>TypeError</code>).</p>
<p>Let&apos;s break down the concepts from <code>ResultProxy</code> to <code>RowProxy</code> a little more:</p>
<ul>
<li><code>executed</code> is a <code>ResultProxy</code>. A <code>session.execute()</code> or <code>connection.execute()</code> method uses the <code>ResultProxy</code> to return its values</li>
<li>When we call <code>fetchone()</code> on <code>ResultProxy</code>, a <code>RowProxy</code> instance is returned</li>
<li>When we fetch more than one row from <code>ResultProxy</code>, a <code>list</code> of <code>RowProxy</code> instances are returned</li>
<li>The <code>RowProxy</code> object has two useful methods:
<ul>
<li><code>.items()</code>: This returns the key, value tuples of all the items in the row as a list</li>
<li><code>.values()</code>: Returns all values as a list</li>
</ul>
</li>
</ul>
<div class="code-chunk" data-id="code-chunk-id-11" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=11, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot; continue=&quot;row-proxy-1&quot;}" class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>fetched<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>fetched<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>fetched<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>fetched<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"><pre class="language-text">[4, 4, &apos;workshoop is so good, more complex and more aplikatif&apos;]
True
[(&apos;timeliness&apos;, 4), (&apos;satisfaction_score&apos;, 4), (&apos;comments&apos;, &apos;workshoop is so good, more complex and more aplikatif&apos;)]
True
</pre></div></div><p>This allows us to unpack each value in the tuple in a <code>for</code> operation:</p>
<div class="code-chunk" data-id="code-chunk-id-12" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=12, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot;}" class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">&apos;sqlite:///rcsample.db&apos;</span><span class="token punctuation">)</span>
conn <span class="token operator">=</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
fetched <span class="token operator">=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;SELECT timeliness, satisfaction_score FROM response ORDER BY workshop_id  LIMIT 3 OFFSET 8&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>fetched<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>fetched<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>fetched<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>fetched<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>has_key<span class="token punctuation">(</span><span class="token string">&apos;timeliness&apos;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
reviews <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>col<span class="token punctuation">:</span>val <span class="token keyword">for</span> col<span class="token punctuation">,</span> val <span class="token keyword">in</span> eachset<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">for</span> eachset <span class="token keyword">in</span> fetched<span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>reviews<span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"><pre class="language-text">[(4, 4), (5, 5), (5, 5)]
[&apos;timeliness&apos;, &apos;satisfaction_score&apos;]
[5, 5]
True
[{&apos;timeliness&apos;: 4, &apos;satisfaction_score&apos;: 4}, {&apos;timeliness&apos;: 5, &apos;satisfaction_score&apos;: 5}, {&apos;timeliness&apos;: 5, &apos;satisfaction_score&apos;: 5}]
</pre></div></div><p>As we&apos;ve seen, <code>RowProxy</code> is really just a proxy for values from a single cursor row. The methods found on the documentation of <code>RowProxy</code> are:</p>
<ul>
<li><code>has_key()</code>: Return True if this <code>RowProxy</code> contains the given key</li>
<li><code>items()</code>: Return a list of types, each tuple containing a key/value pair</li>
<li><code>keys()</code>: Return the list of keys as strings</li>
</ul>
<p>Curiously, <code>values()</code> is not a documented method, even though as we&apos;ve seen above it return the values of a single cursor row as a list.</p>
<h3 class="mume-header" id="multiple-rowproxy-is-returned-as-a-list">Multiple <code>RowProxy</code> is returned as a <code>list</code></h3>

<p>In the following code:</p>
<ul>
<li><code>executed</code> is a <code>ResultProxy</code></li>
<li>Because the <code>ResultProxy</code> contains more than one value, when we call <code>fetchall()</code> it returns a <code>list</code> containing multiple instances of <code>RowProxy</code> instead. Have it contain only one row, it would have return <code>fetched()</code> as a <code>RowProxy</code></li>
<li><code>fetched[0]</code> points to the first value in the row, and is a <code>RowProxy</code> object</li>
<li>Additionally, because each <code>RowProxy</code> has a length of 2, it can be unpacked into a dictionary using <code>dict()</code>. A <code>ValueError</code> exception will be raised if our <code>RowProxy</code> has a length of any other value.</li>
</ul>
<div class="code-chunk" data-id="code-chunk-id-13" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=13, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot;}" class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">&apos;sqlite:///:memory:&apos;</span><span class="token punctuation">)</span>
conn <span class="token operator">=</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;CREATE TABLE &quot;salesperson&quot; (&apos;</span>
           <span class="token string">&apos;id INTEGER NOT NULL,&apos;</span>
           <span class="token string">&apos;name VARCHAR,&apos;</span>
           <span class="token string">&apos;PRIMARY KEY (id));&apos;</span><span class="token punctuation">)</span>
conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;INSERT INTO &quot;salesperson&quot; (name)&apos;</span>
         <span class="token string">&apos;VALUES (&quot;John Doe&quot;), (&quot;Margaret&quot;), (&quot;Anna&quot;)&apos;</span><span class="token punctuation">)</span>
executed <span class="token operator">=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;SELECT * FROM salesperson&apos;</span><span class="token punctuation">)</span>
fetched <span class="token operator">=</span> executed<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>fetched<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>fetched<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">(</span>fetched<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"><pre class="language-text">[(1, &apos;John Doe&apos;), (2, &apos;Margaret&apos;), (3, &apos;Anna&apos;)]
True
{1: &apos;John Doe&apos;, 2: &apos;Margaret&apos;, 3: &apos;Anna&apos;}
</pre></div></div><h3 class="mume-header" id="queue-pool">Queue Pool</h3>

<p>Whenever the <code>connect()</code> or <code>execute()</code> methods are called, the <code>Engine</code> will ask the connection pool for a connection. The default connection pool, <code>QueuePool</code> will open connections to the database on an as-needed basis; As concurrent statements are executed, <code>QueuePool</code> will grow its pool of connections to a defaulot size of five, and allow a default &quot;overflow&quot; of ten.</p>
<blockquote>
<p>Tip:<br>
<code>QueuePool</code> is not used by default for SQLite engines</p>
</blockquote>
<p>We can overwrite the above using the Engine Creation API.</p>
<pre data-role="codeBlock" data-info="py" class="language-python">engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span>
    <span class="token string">&quot;mysql://scott:tiger@hostname/dbname&quot;</span><span class="token punctuation">,</span>
    case_sensitive<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    encoding<span class="token operator">=</span><span class="token string">&apos;latin1&apos;</span><span class="token punctuation">,</span> 
    pool_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
    max_overflow<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
</pre><p>The several parameters in our engine creation call above:</p>
<ul>
<li><strong>case_sensitive=True</strong>: if False, result columns names will match in a case-insensitive fashion</li>
<li><strong>encoding</strong>: defaults to <code>utf-8</code>; The string encoding used by SQLAlchemy for string encode/decode operations which occur within SQLAlchemy, <strong>outside of the DBAPI</strong></li>
<li><strong>pool_size</strong>: number of connections to keep open. To disable pooling, set <code>poolclass</code> to <code>NullPool</code>, a <code>pool_size</code> setting of 0 indicates no limit</li>
<li><strong>max_overflow</strong>: number of connections to allow in connection pool &quot;overflow&quot;, that is connections that can be opened above and beyond the <code>pool_size</code> setting</li>
</ul>
<hr>
<p>Knowledge Check:</p>
<ol>
<li>
<p>Use the <code>engine.table_names()</code> to print the table names from <code>rcsample.db</code>. How many tables were there?</p>
</li>
<li>
<p>Create an engine just like you did in (1) and execute a SQL query to count the number of rows within the <code>employee</code> table. How many rows are there?</p>
</li>
</ol>
<p>For question (3) to (6), use the following code:</p>
<div class="code-chunk" data-id="code-chunk-id-14" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=14, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot;}" class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">&apos;sqlite:///:memory:&apos;</span><span class="token punctuation">)</span>
conn <span class="token operator">=</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;CREATE TABLE &quot;salesperson&quot; (&apos;</span>
           <span class="token string">&apos;id INTEGER NOT NULL,&apos;</span>
           <span class="token string">&apos;name VARCHAR,&apos;</span>
           <span class="token string">&apos;PRIMARY KEY (id));&apos;</span><span class="token punctuation">)</span>
conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;INSERT INTO &quot;salesperson&quot; (name)&apos;</span>
         <span class="token string">&apos;VALUES (&quot;John Doe&quot;), (&quot;Margaret&quot;), (&quot;Anna&quot;)&apos;</span><span class="token punctuation">)</span>
executed <span class="token operator">=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;SELECT * FROM salesperson&apos;</span><span class="token punctuation">)</span>
fetched <span class="token operator">=</span> executed<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span>
results <span class="token operator">+=</span> executed<span class="token punctuation">.</span>fetchmany<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><ol start="3">
<li>
<p>What is the output of <code>len(fetched.values())</code>?</p>
</li>
<li>
<p>What is the output of <code>len(results)</code>?</p>
</li>
<li>
<p>Is <code>results</code> an instance of <code>list</code>?</p>
</li>
<li>
<p>Is <code>results[0]</code> an instance of <code>tuple</code>?</p>
</li>
</ol>
<details>
<summary>Hint:</summary>
<p>
</p><p>Hint for question (1):</p>
<pre data-role="codeBlock" data-info="py" class="language-python"><span class="token comment"># import engine...</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>engine<span class="token punctuation">.</span>table_names<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p>Hint for question (2):</p>
<pre data-role="codeBlock" data-info="py" class="language-python"><span class="token comment"># import engine and wrap sql command</span>
conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;SELECT COUNT(*) FROM employee&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scalar<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p></p>
</details>
<hr>
<h2 class="mume-header" id="transactions">Transactions</h2>

<p>In database lingo, <strong>transaction</strong> is a logical, atomic unit of work that contains one or more SQL statements. Database users use transaction to group SQL statements so that they are either all committed (which means applied to the database), or all rolled back.</p>
<p>We use <code>Transactions</code> directly when working with <code>Engine</code> and <code>Connection</code> objects, but rarely so when we work with SQLAlchemy ORM (we&apos;ll get to what ORM means in the next chapter).</p>
<p>The <code>Connection</code> object provides a <code>begin()</code> method which returns an instance of <code>Transaction</code> - this instance represents the &quot;scope&quot; of the transaction so that it&apos;s guaranteed to invoke one, and <strong>only one</strong>, of two methods:</p>
<ul>
<li><code>Transaction.rollback()</code></li>
<li><code>Transaction.commit()</code></li>
</ul>
<p>The transaction &quot;scope&quot; completes when one of the two method above is called. The <code>Transaction</code> object is usually used within a try/except clause but it also implements a context manager interface so Python&apos;s <code>with</code> statement can be used in the following way:</p>
<div class="code-chunk" data-id="code-chunk-id-15" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=15, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot;}" class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">&apos;sqlite:///salesperson.db&apos;</span><span class="token punctuation">)</span>
results <span class="token operator">=</span> engine<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;SELECT * FROM salesperson&apos;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Before transaction:&quot;</span><span class="token punctuation">,</span> results<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> engine<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
    conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;INSERT INTO &quot;salesperson&quot; (name)&apos;</span>
             <span class="token string">&apos;VALUES (&quot;Marshall&quot;)&apos;</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;INSERT INTO &quot;salesperson&quot; (name)&apos;</span>
             <span class="token string">&apos;VALUES (&quot;John Doe&quot;), (&quot;Margaret&quot;), (&quot;Anna&quot;)&apos;</span><span class="token punctuation">)</span>

results <span class="token operator">=</span> engine<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;SELECT * FROM salesperson&apos;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;After transaction:&quot;</span><span class="token punctuation">,</span>results<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">&apos;salesperson.db&apos;</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"><pre class="language-text">Traceback (most recent call last):
  File &quot;/Users/samuel/.virtualenvs/revconnexion/lib/python3.7/site-packages/sqlalchemy/engine/base.py&quot;, line 1244, in _execute_context
    cursor, statement, parameters, context
  File &quot;/Users/samuel/.virtualenvs/revconnexion/lib/python3.7/site-packages/sqlalchemy/engine/default.py&quot;, line 552, in do_execute
    cursor.execute(statement, parameters)
sqlite3.OperationalError: no such table: salesperson

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File &quot;/Users/samuel/Documents/GU_sqlalchemy/dmkgtj8yd_code_chunk&quot;, line 4, in <module>
    results = engine.execute(&apos;SELECT * FROM salesperson&apos;)
  File &quot;/Users/samuel/.virtualenvs/revconnexion/lib/python3.7/site-packages/sqlalchemy/engine/base.py&quot;, line 2166, in execute
    return connection.execute(statement, *multiparams, **params)
  File &quot;/Users/samuel/.virtualenvs/revconnexion/lib/python3.7/site-packages/sqlalchemy/engine/base.py&quot;, line 982, in execute
    return self._execute_text(object_, multiparams, params)
  File &quot;/Users/samuel/.virtualenvs/revconnexion/lib/python3.7/site-packages/sqlalchemy/engine/base.py&quot;, line 1155, in _execute_text
    parameters,
  File &quot;/Users/samuel/.virtualenvs/revconnexion/lib/python3.7/site-packages/sqlalchemy/engine/base.py&quot;, line 1248, in _execute_context
    e, statement, parameters, cursor, context
  File &quot;/Users/samuel/.virtualenvs/revconnexion/lib/python3.7/site-packages/sqlalchemy/engine/base.py&quot;, line 1466, in _handle_dbapi_exception
    util.raise_from_cause(sqlalchemy_exception, exc_info)
  File &quot;/Users/samuel/.virtualenvs/revconnexion/lib/python3.7/site-packages/sqlalchemy/util/compat.py&quot;, line 383, in raise_from_cause
    reraise(type(exception), exception, tb=exc_tb, cause=cause)
  File &quot;/Users/samuel/.virtualenvs/revconnexion/lib/python3.7/site-packages/sqlalchemy/util/compat.py&quot;, line 128, in reraise
    raise value.with_traceback(tb)
  File &quot;/Users/samuel/.virtualenvs/revconnexion/lib/python3.7/site-packages/sqlalchemy/engine/base.py&quot;, line 1244, in _execute_context
    cursor, statement, parameters, context
  File &quot;/Users/samuel/.virtualenvs/revconnexion/lib/python3.7/site-packages/sqlalchemy/engine/default.py&quot;, line 552, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: salesperson
[SQL: SELECT * FROM salesperson]
(Background on this error at: http://sqlalche.me/e/e3q8)
</module></pre></div></div><p>Now, have we tried a simple experiment by changing the last <code>INSERT</code> clause to say <code>INSERT INTO &quot;salespeople&quot; (name)</code> instead of <code>INSERT INTO &quot;salesperson (name)&quot;</code>, what do you think would happen?</p>
<p>To verify this, you can open <code>salesperson.db</code> using any of your favorite sqlite browser, and hopefully, you will see that Marshall is not included in the table. Yes - the earlier <code>INSERT</code> clause did not take effect as the Transaction wasn&apos;t completed.</p>
<p>This follows the &quot;A&quot; in &quot;ACID&quot;, which is short for <strong>Atomicity</strong>. All tasks of a transaction are performed or none of them are. There are no partial transactions. If a transaction starts updating 10 rows but fails after 7 rows, the database rolls back the changes to these 7 rows.</p>
<h3 class="mume-header" id="not-everything-can-be-rolled-back">Not everything can be &quot;rolled back&quot;</h3>

<p>For an SQLAlchemy user not particularly familiar with SQL, sometimes its not obvious when an unexpected behavior is due to SQLAlchemy&apos;s design decisions or characteristics of the underlying database. One such example is the <code>rollback()</code> method.</p>
<p>Consider the following example of <code>Transction</code>. The code is similar to the context-manager one above, with one change: we&apos;re using a try/except clause instead of a context manager. This allow me to exclude a <code>raise()</code>, with the except clause is executed.</p>
<div class="code-chunk" data-id="code-chunk-id-16" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=16, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot;}" class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">&apos;sqlite:///:memory:&apos;</span><span class="token punctuation">)</span>
tbl_names <span class="token operator">=</span> engine<span class="token punctuation">.</span>table_names
<span class="token keyword">print</span><span class="token punctuation">(</span>tbl_names<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
conn <span class="token operator">=</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
trans <span class="token operator">=</span> conn<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span>
results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;CREATE TABLE &quot;salesperson&quot; (&apos;</span>
               <span class="token string">&apos;id INTEGER NOT NULL,&apos;</span>
               <span class="token string">&apos;name VARCHAR,&apos;</span>
               <span class="token string">&apos;PRIMARY KEY (id));&apos;</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;INSERT INTO &quot;salesperson&quot; (name)&apos;</span>
             <span class="token string">&apos;VALUES (&quot;John Doe&quot;), (&quot;Margaret&quot;), (&quot;Anna&quot;)&apos;</span><span class="token punctuation">)</span>
    results <span class="token operator">+=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;SELECT * FROM salesperson&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fetchmany<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    trans<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span><span class="token punctuation">:</span>
    trans<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># raise()</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>tbl_names<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"><pre class="language-text">[]
[(1, &apos;John Doe&apos;), (2, &apos;Margaret&apos;), (3, &apos;Anna&apos;)]
[&apos;salesperson&apos;]
</pre></div></div><p>Let&apos;s inspect the three <code>print</code> statements in the order of execution:</p>
<ol>
<li><code>print(tbl_names)</code> in line 4 returns an empty list. At this point, no tables were created yet in our in-memory database.</li>
<li><code>print(results)</code> returns a list of <code>RowProxy</code> as was described above</li>
</ol>
<p>Supposed we repeat our experiment by changing the last <code>INSERT</code> clause to say <code>INSERT INTO &quot;salespeople&quot; (name)</code> instead of <code>INSERT INTO &quot;salesperson (name)&quot;</code>, what do you think would happen to the two <code>print</code> statements at the bottom?</p>
<p>You may have guessed that we got two empty lists (<code>[]</code>). Except that&apos;s not what happened. As it turns out, we got an empty list (<code>[]</code>) from printing <code>results</code> but our <code>tbl_names()</code> return <code>[&apos;salesperson&apos;]</code>.</p>
<p>This brings us to another concept in database systems: <strong>not all statements can be rolled back</strong>. From the <a href="https://dev.mysql.com/doc/refman/8.0/en/cannot-roll-back.html">MySQL Reference Manual</a>:</p>
<blockquote>
<p>Some statements cannot be rolled back. In general, these include data definition language (DDL) statements, such as those that create or drop databases, those that create, drop, or alter tables or stored routines.</p>
<p>You should design your transactions not to include such statements. If you issue a statement early in a transaction that cannot be rolled back, and then another statement later fails, the full effect of the transaction cannot be rolled back in such cases by issuing a ROLLBACK statement.</p>
</blockquote>
<p>MySQL is not alone in how in its implementation of <code>ROLLBACK</code>. Oracle Database has this <a href="https://docs.oracle.com/database/121/SQLRF/statements_4011.htm#SQLRF01110">in their documentation</a>:</p>
<blockquote>
<p>Oracle Database issues an implicit COMMIT under the following circumstances:</p>
<ul>
<li>
<p>Before any syntactically valid data definition language (DDL) statement, even if the statement results in an error</p>
</li>
<li>
<p>After any data definition language (DDL) statement that completes without an error</p>
</li>
</ul>
</blockquote>
<p>In simpler English, Oracle Database issues an implicit commit after any DDL statement, <a href="https://dev.mysql.com/doc/refman/5.7/en/implicit-commit.html">as does MySQL</a>.</p>
<p>To add to the confusion, every database handles this differently.</p>
<ul>
<li>In <strong>SQLite</strong>, <code>ALTER</code> statements can be rolled back but not <code>CREATE TABLE</code></li>
<li>Most DDL statements can be rolled back in <strong>Postgres</strong> with some exceptions including <code>DROP DATABASE</code> and <code>TRUNCATE</code></li>
<li>Some database, like H2, <a href="http://www.h2database.com/html/advanced.html">also performs an implicit commit</a> after a DDL statement</li>
</ul>
<p>My recommendation is to read the official documentation relating to your choice of database and write code to minimize the use of DDL statements in transactions (adopt a proper database migration workflow for DDL changes instead).</p>
<h3 class="mume-header" id="what-exactly-is-being-rolled-back">What exactly is being rolled back?</h3>

<p>Look at the output of the following. Notice that there are four <code>.execute</code> commands in the <code>try</code> block. The last execution was unsuccessful because of a misspelling (<code>salespeople</code> instead of <code>salesperson</code>) so a rollback occured.</p>
<div class="code-chunk" data-id="code-chunk-id-17" data-cmd="/Users/samuel/.virtualenvs/revconnexion/bin/python"><div class="input-div"><pre data-role="codeBlock" data-info="py {code_chunk_offset=17, cmd=&quot;/Users/samuel/.virtualenvs/revconnexion/bin/python&quot;}" class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">&apos;sqlite:///:memory:&apos;</span><span class="token punctuation">)</span>
tbl_names <span class="token operator">=</span> engine<span class="token punctuation">.</span>table_names
conn <span class="token operator">=</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
trans <span class="token operator">=</span> conn<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span>
results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;CREATE TABLE &quot;salesperson&quot; (&apos;</span>
               <span class="token string">&apos;id INTEGER NOT NULL,&apos;</span>
               <span class="token string">&apos;name VARCHAR,&apos;</span>
               <span class="token string">&apos;PRIMARY KEY (id));&apos;</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;INSERT INTO &quot;salesperson&quot; (name)&apos;</span>
             <span class="token string">&apos;VALUES (&quot;John Doe&quot;), (&quot;Margaret&quot;), (&quot;Anna&quot;)&apos;</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;ALTER TABLE salesperson ADD address VARCHAR;&apos;</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;ALTER TABLE salespeople ADD emailadd VARCHAR;&apos;</span><span class="token punctuation">)</span>
    trans<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Unsuccessful. Rolling back.&quot;</span><span class="token punctuation">)</span>
    trans<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
results <span class="token operator">+=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;SELECT * FROM salesperson&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
keys <span class="token operator">=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;SELECT * FROM salesperson&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span>
vals <span class="token operator">=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&apos;SELECT * FROM salesperson&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Tables: </span><span class="token interpolation"><span class="token punctuation">{</span>tbl_names<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Keys: </span><span class="token interpolation"><span class="token punctuation">{</span>keys<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Results: </span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Values: </span><span class="token interpolation"><span class="token punctuation">{</span>vals<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"><pre class="language-text">Unsuccessful. Rolling back.
Tables: [&apos;salesperson&apos;]
Keys: [&apos;id&apos;, &apos;name&apos;]
Results: []
Values: None
</pre></div></div><p>While <code>.rollback()</code> is invoked, the <code>CREATE TABLE</code> was <strong>not rolled back</strong>. The any modifications on the database resulting from the other 3 commands, repectively <code>INSERT</code>, <code>ALTER</code> and <code>ALTER</code>,  were rolled back however. This explained the resulting output from <code>tbl_names</code> and <code>keys</code> but an empty list in <code>results</code>.</p>
<p>In your mind, do the following experiment: imagine what would happen if we move the line of code:<br>
<code>results += conn.execute(&apos;SELECT * FROM salesperson&apos;).fetchall()</code><br>
such that it is before the two lines that perform the <code>ALTER TABLE</code> command.</p>
<p>Would <code>results</code> still be an empty string?</p>
<p>To answer the question, it is important to realize that modifications to the database are beling rolled back, not python objects themselves. Have we move the <code>results += conn.execute(...)</code> line of code into the the <code>try</code> block and after the <code>INSERT INTO</code> command is executed, <code>results</code> would no longer be an empty list. Changes to the database are rolled back -- not changes to database objects!</p>
<h2 class="mume-header" id="summary">Summary</h2>

<p>In coursebook (1), we&apos;ve covered some of the most fundamental inner-workings of SQLAlchemy. In particular, we&apos;ve learned:</p>
<ul>
<li>Using <code>create_engine</code> to instantiate an <code>Engine</code> object</li>
<li>about <code>Connection</code> and using <code>connection.execute()</code></li>
<li>fetching results with one of the <code>fetchXXX</code> triplets</li>
<li>about <code>ResultProxy</code> and <code>RowProxy</code></li>
<li>queue pool and the Soft Close</li>
<li><code>Transactions</code></li>
<li>executing <code>ROLLBACK</code></li>
</ul>

      </div>
      <div class="md-sidebar-toc"><ol>
<li><a href="#ground-up-tutorial-to-sqlalchemy-course-1">Ground Up tutorial to SQLAlchemy: Course 1</a>
<ol>
<li><a href="#understanding-engine-and-connection">Understanding <code>Engine</code> and <code>Connection</code></a></li>
<li><a href="#working-with-engines-directly">Working with Engines directly</a>
<ol>
<li><a href="#understanding-resultproxyclose">Understanding <code>ResultProxy.close()</code></a>
<ol>
<li><a href="#the-soft-close">The Soft Close</a></li>
</ol>
</li>
<li><a href="#rowproxy-like-tuples-but-not-really"><code>RowProxy</code>: Like Tuples, but not really</a></li>
<li><a href="#multiple-rowproxy-is-returned-as-a-list">Multiple <code>RowProxy</code> is returned as a <code>list</code></a></li>
<li><a href="#queue-pool">Queue Pool</a></li>
</ol>
</li>
<li><a href="#transactions">Transactions</a>
<ol>
<li><a href="#not-everything-can-be-rolled-back">Not everything can be &quot;rolled back&quot;</a></li>
<li><a href="#what-exactly-is-being-rolled-back">What exactly is being rolled back?</a></li>
</ol>
</li>
<li><a href="#summary">Summary</a></li>
</ol>
</li>
</ol>
</div>
      <a id="sidebar-toc-btn">&#x2261;</a>
    
    
    
    
    
    
    
    
<script>

var sidebarTOCBtn = document.getElementById('sidebar-toc-btn')
sidebarTOCBtn.addEventListener('click', function(event) {
  event.stopPropagation()
  if (document.body.hasAttribute('html-show-sidebar-toc')) {
    document.body.removeAttribute('html-show-sidebar-toc')
  } else {
    document.body.setAttribute('html-show-sidebar-toc', true)
  }
})
</script>
      
  
    </body></html>